#Note: The calculations in this script take only a couple of seconds/minutes on an Intel(R) 
#      Xeon(R) Gold 6136 CPU with 3.00 GHz on a 64-Bit Windows Server 2016 with 24 processors.

library("copula")

################################# VULNERABILITY COVAR #####################################
get_VCoVaR = function(copula, theta, alpha = 0.05, beta = 0.05){
  if(copula == "gumbel"){
    cop = rotCopula(gumbelCopula(param = theta, dim = 3))
  }
  if(copula == "clayton"){
    cop = rotCopula(claytonCopula(param = theta, dim = 3))
  }
  
  MinF = function(v){
    return((v - pCopula(c(1, 1-alpha, 1-alpha), copula = cop) + 
              pCopula(c(1-v, 1-alpha, 1-alpha), copula = cop)) -
             (beta * (1 - pCopula(c(1, 1-alpha, 1-alpha), copula = cop))))
  }
  tmp = uniroot(f = MinF, lower = 0, upper = 1, tol = .Machine$double.eps*0.0000001, 
                maxiter = 10000000)$root
  VCoVaR = qnorm(tmp)
}

#Vulnerability params
set.seed(1)
tau = seq(0.001, 0.999, length.out = 500)

theta_Gu = iTau(copula = gumbelCopula(), tau = tau)
theta_Cl = iTau(copula = claytonCopula(), tau = tau)

### alpha = beta = 0.05 ###
#gumbel copula
V_gumbel = c()
for(i in seq_along(theta_Gu)){
  V_gumbel[i] = get_VCoVaR(copula = "gumbel", theta = theta_Gu[i], 
                           alpha = 0.05, beta = 0.05)
}

#clayton copula
V_clayton = c()
for(i in seq_along(theta_Cl)){
  V_clayton[i] = get_VCoVaR(copula = "clayton", theta = theta_Cl[i], 
                            alpha = 0.05, beta = 0.05)
}

#Comparison
plot(tau, V_gumbel, type = "l", xlim = c(0, 1), xlab = expression(tau), 
     ylab = "VCoVaR", col = "blue3", lwd = 2,
     main = "Vulnerability-CoVaR with standard normal margins")
lines(tau, V_clayton, col = "red3", lwd = 2)
legend("right", col = c("blue3", "red3"), bty = "n", density = c(0,0), lwd = 2,
       legend = c("gumbel", "clayton"), border = c(NA,NA), lty = c(1,1))
mtext(text = expression(paste(alpha, " = ", beta, " = 0.05")))
abline(h = qnorm(0.05*0.05), lwd = 2, col = "darkgrey", lty = 2)
abline(h = qnorm(0.05), lwd = 2, col = "darkgrey", lty = 2)

### alpha = beta = 0.01 ###
#gumbel copula
V_gumbel = c()
for(i in seq_along(theta_Gu)){
  V_gumbel[i] = get_VCoVaR(copula = "gumbel", theta = theta_Gu[i], 
                           alpha = 0.01, beta = 0.01)
}

#clayton copula
V_clayton = c()
for(i in seq_along(theta_Cl)){
  V_clayton[i] = get_VCoVaR(copula = "clayton", theta = theta_Cl[i], 
                            alpha = 0.01, beta = 0.01)
}

#Comparison
plot(tau, V_gumbel, type = "l", xlim = c(0, 1), xlab = expression(tau), 
     ylab = "VCoVaR", col = "blue3", lwd = 2,
     main = "Vulnerability-CoVaR with standard normal margins")
lines(tau, V_clayton, col = "red3", lwd = 2)
legend("right", col = c("blue3", "red3"), bty = "n", density = c(0,0), lwd = 2,
       legend = c("gumbel", "clayton"), border = c(NA,NA), lty = c(1,1))
mtext(text = expression(paste(alpha, " = ", beta, " = 0.01")))
abline(h = qnorm(0.01*0.01), lwd = 2, col = "darkgrey", lty = 2)
abline(h = qnorm(0.01), lwd = 2, col = "darkgrey", lty = 2)
